class BinaryReader:
    TIME_PLAN = [
        ("year", [12, 0, 4095]),
        ("month", [4, 1, 12]),
        ("day", [5, 1, 31]),
        ("hour", [5, 0, 23]),
        ("minute", [6, 0, 59]),
        ("second", [6, 0, 59]),
        ("milisecond", [10, 0, 999])
    ]
    
    SENSORS = [
        ("system", [(8, "int", 0, 255)]),                                                 # 0 : System State
        ("temperature", [(16, "int^1", 0, 1000)]),                                        # 1 : Temperature
        ("pressure", [(16, "int^2", 850_00, 1050_00)]),                                   # 2 : Pressure
        ("Humidity", [(16, "int^1", 0, 1000)]),                                           # 3 : Humidity
        ("Altitude", [(16, "int", 0, 10_000)]),                                           # 4 : Altitude
        ("Acc", [(8, "int", -127, 127), (8, "int", -127, 127), (8, "int", -127, 127)]),   # 5 : Acc (3)
        ("Gyro", [(8, "int", -127, 127), (8, "int", -127, 127), (8, "int", -127, 127)]),  # 6 : Gyro (3)
        ("Mag", [(8, "int", -127, 127), (8, "int", -127, 127), (8, "int", -127, 127)]),   # 7 : Mag (3)
    ]
    
    def __init__(self):
        pass
        
    def pack_data(self, plan: list, data: dict) -> bytes:
        ### PLAN + DATA ==> BYTES
        
        pack = 0
        bit_position = 0
        
        for name, field_info in plan: 
            bits, min_val, max_val = field_info
            
            # Get value
            value = data.get(name)
            if value is None:
                raise ValueError(f"Where is the data ?: {name}")
            
            # Check value
            if not (min_val <= value <= max_val):
                raise ValueError(f"Value {name}={value} too large [{min_val}-{max_val}]")
            value -= min_val
            # Mask
            mask = (1 << bits) - 1
            
            # Let's do it
            pack <<= bits
            pack |= (value & mask)  
            
            bit_position += bits
        
        # Count bytes
        total_bits = bit_position
        num_bytes = (total_bits + 7) // 8
        
        # Convert to bytes (big)
        return pack.to_bytes(num_bytes, 'big')
    
    def pack_datetime(self, year, month, day, hour, minute, second, milisecond) -> bytes:
        ### PACK FULL TIME
        data = {
            "year": year,
            "month": month,
            "day": day,
            "hour": hour,
            "minute": minute,
            "second": second,
            "milisecond": milisecond
        }
        return self.pack_data(self.TIME_PLAN, data)
    
    def get_sensor_data_plan(self, id):
        plan = [
            ("id", [8, 0, 255]), 
            ("second", [6, 0, 59]),
            ("mili", [10, 0, 999])
        ]
        i = 0
        for dt in self.SENSORS[id][1]:
            bytes_count = (dt[0] + 7) // 8
            v_min = dt[2]
            v_max = dt[3]
            
            plan.append(("#" + str(i), [bytes_count*8, v_min, v_max]))
            i += 1
        
        return plan
    
    def unpack_data(self, plan: list, packed_bytes: bytes) -> dict:
        ### BUCKET OF BYTES + PLAN ==> DATA
        
        # Convert data
        packed_int = int.from_bytes(packed_bytes, 'big')
        
        result = {}
        
        total_bits = sum(info[0] for _, info in plan) 
        
        remaining = packed_int
        
        for name, field_info in reversed(plan): 
            bits, min_val, max_val = field_info
            
            # Mask
            mask = (1 << bits) - 1
            
            # Extract value
            value = remaining & mask
            value += min_val
            result[name] = value
            
            # I like to move it it
            remaining >>= bits
        
        ordered_result = {}
        for name, _ in plan: 
            ordered_result[name] = result[name]
        
        return ordered_result

reader = BinaryReader()

### 1 000 lines of bin
bytes_data = bytes.fromhex('7ea0830f3df40000000100500002003c0003008c00040050000500580006006c0007001c0008005400090084000a007c000b0080000c0088000d0010000e0038000f002000100070001100900012000400130014001400a80015003400160078001700080018009c00190040001a007c001b007c001c006c001d00a4001e00a4001f00100020008000210050002200140023009400240038002500180026007400270004002800900029002c0000009c0001006800020050000300200004005c0005005c00060018000700280008004000090030000a0084000b0030000c0098000d0080000e0024000f004c001000740011008c0012002000130020001400480015005c001600100017006c0018000800190048001a0064001b002c001c0018001d002c001e0090001f0090002000540021005800220090002300a80024006800250028002600a8002700540028001c002900540000009c000100480002002800030014000400680005002800060054000700740008000c00090074000a005c000b0088000c006c000d009c000e0014000f0020001000300011001c00120034001300900014007c0015003800160068001700080018004c00190050001a0050001b0030001c0050001d0080001e0094001f006000200018002100180022009c00230024002400940025006800260038002700100028002000290080000000940001006c00020098000300a40004004400050078000600800007004c0008001000090098000a002c000b0040000c0030000d009c000e0078000f0068001000a80011008400120040001300a4001400a40015006c0016006c0017009800180044001900a8001a0030001b008c001c0028001d0048001e0038001f0080002000a400210048002200980023007c00240068002500240026009800270098002800680029007c000000a400010024000200380003000c00040058000500180006006c000700640008008000090038000a0078000b008c000c0088000d0054000e0098000f0090001000140011007000120030001300a8001400580015001400160060001700180018005c00190020001a0084001b0040001c004c001d0034001e0034001f00a40020006c0021007c00220038002300200024000400250018002600600027009c0028007400290068000000300001002400020018000300600004003c0005009000060030000700740008007400090078000a001c000b004c000c0040000d0088000e0020000f0028001000800011001c001200700013009c00140080001500a8001600480017006400180044001900a4001a0074001b000c001c0084001d0018001e0024001f00740020000800210040002200a400230070002400740025002c002600480027003c002800a00029008c000000a40001009c0002009000030018000400100005006c0006007c000700740008009400090090000a003c000b0094000c0074000d0064000e007c000f008c00100078001100a40012006c0013001800140040001500540016008c0017000400180018001900a8001a000c001b0044001c008c001d0050001e0048001f00840020008000210068002200880023006400240084002500a00026005c002700680028006c002900a80000009c000100540002003800030040000400640005003c000600140007002c0008001c0009003c000a0028000b0080000c0018000d0084000e0010000f0028001000740011007c00120054001300780014000c001500240016009c001700a40018001400190018001a0030001b004c001c0094001d005c001e00a4001f006c0020006800210054002200440023004400240030002500580026002400270080002800340029005400000060000100600002001400030094000400a80005004400060064000700a80008000c0009006c000a0060000b00a4000c0058000d0020000e0020000f007000100078001100540012002c0013004000140098001500680016007c001700100018007000190088001a000c001b0078001c006c001d0014001e0044001f002800200090002100940022002c00230054002400600025003c00260074002700840028009800290008000000480001005c00020020000300700004000c000500940006006c0007008c0008004c00090060000a0074000b0094000c0058000d0014000e001c000f0038001000900011004800120068001300480014004c001500a400160008001700540018007800190024001a0048001b006c001c0038001d0028001e0024001f003400200048002100540022000c0023004800240064002500540026006800270010002800880029009c0000001000010030000200580003008c0004008c0005003000060068000700280008004000090034000a003c000b0040000c001c000d005c000e0004000f00780010000c001100980012005800130028001400a000150024001600500017001c0018001800190020001a0064001b0020001c0060001d0020001e0090001f00380020002c002100940022002400230028002400280025004c0026002c00270024002800240029009c000000840001002c0002008c0003007800040008000500700006008400070018000800440009006c000a000c000b0038000c0020000d0004000e0004000f0070001000500011006c0012000c0013005000140020001500740016008c00170014001800340019006c001a0090001b0038001c000c001d0094001e0030001f008c002000100021009c002200200023001800240044002500440026004000270014002800a800290030000000140001007c000200940003004000040034000500080006004c000700380008009800090044000a0044000b0088000c0078000d0034000e0058000f007400100054001100500012004000130038001400780015001c0016002c001700780018005400190084001a0094001b0034001c009c001d00a0001e007c001f00680020000400210018002200600023008400240074002500300026001c0027007000280008002900140000000c0001001000020058000300580004006000050078000600080007009c0008003000090070000a0034000b0040000c0068000d0014000e0074000f00a400100048001100240012006000130024001400740015002c00160044001700040018005c00190068001a0054001b0050001c005c001d0010001e0080001f001c00200070002100840022006c00230030002400200025000c002600740027001000280084002900280000005000010088000200340003005c000400340005006c000600700007004c000800240009007c000a0028000b000c000c0064000d0010000e0080000f0094001000540011009c0012008c00130088001400900015006800160050001700940018003000190028001a0060001b0090001c0018001d008c001e0078001f0090002000440021007400220068002300380024003400250078002600500027002c002800240029002400000030000100800002005c0003005c000400480005001c0006009400070014000800a400090078000a0080000b0094000c0084000d0074000e0090000f002400100024001100540012006c001300900014000c0015008400160098001700480018009400190088001a0040001b0020001c0088001d0038001e0030001f000400200030002100440022008400230058002400180025001c002600140027005400280038002900880000006c00010038000200a000030078000400100005007c000600140007000c0008007c00090004000a0098000b0030000c00a8000d008c000e007c000f002c00100030001100180012005400130060001400a40015006c0016002800170014001800400019009c001a0084001b005c001c0070001d004c001e0054001f001c002000340021009c00220068002300300024004c00250014002600a8002700500028000c0029003c000000680001000400020020000300340004009800050058000600840007001c000800200009006c000a003c000b0050000c0050000d006c000e0074000f004c0010005000110088001200900013008000140060001500780016002c001700580018002800190090001a0020001b0010001c0018001d0004001e0040001f0078002000300021005c0022007000230044002400640025000400260004002700200028007c0029003c0000005000010050000200500003009400040030000500a800060098000700800008007000090088000a004c000b000c000c00a8000d0098000e00a4000f0030001000a0001100740012005c00130064001400740015006400160008001700200018007000190060001a0050001b0030001c0094001d0044001e0014001f00280020004c002100380022002800230084002400280025004400260078002700480028009c002900140000006c00010074000200700003000c000400040005003000060090000700680008005800090044000a001c000b0028000c007c000d0078000e001c000f0064001000300011002800120040001300340014002c001500680016009800170038001800740019001c001a0018001b004c001c0060001d0098001e0034001f0044002000a00021005c002200080023005c002400500025008c00260028002700040028003c002900640000002c0001009c0002004000030074000400080005000c00060020000700100008009000090060000a0064000b0038000c0098000d006c000e0098000f00600010001800110094001200140013004c001400700015005c001600340017006c0018008800190014001a0080001b009c001c0074001d00a0001e009c001f00440020004000210054002200280023003c002400180025009800260080002700380028005800290044000000080001004c0002008c00030070000400100005002c000600680007003c000800280009003c000a0078000b0034000c00a4000d0040000e0068000f00600010007800110074001200080013008400140044001500240016007c001700780018000800190050001a0020001b0098001c003c001d0084001e0088001f00600020000c002100040022004c002300780024008c0025008c002600a40027008800280098002900a400000088000100540002002400030020000400a40005000800060078000700800008009000090038000a0048000b00a8000c0050000d0054000e0090000f00540010000c001100200012001000130090001400640015003000160070001700880018008c00190018001a0074001b0008001c0078001d0090001e0078001f005c0020001000210038002200800023009400240024002500740026008c00270090002800500029001c0000002000010084000200100003000400040048000500300006003c000700380008008c00090028000a00a0000b0074000c0080000d000c000e005c000f00340010002800110090001200300013006400140068001500080016002000170098001800640019007c001a0030001b003c001c000c001d0068001e008c001f008c00200068002100980022007c0023')

print("ANALYSE STARTED")
print("Total bytes:", len(bytes_data))
actual_time = reader.unpack_data(reader.TIME_PLAN, bytes_data[:6])
print("Start time:", f"{actual_time['day']}-{actual_time['month']}-{actual_time['year']}  {actual_time['hour']}:{actual_time['minute']}:{actual_time['second']}.{actual_time['milisecond']}")

t = (actual_time["hour"] * 3600 + actual_time["minute"] * 60 + actual_time['second'])*1000 + actual_time['milisecond']

index = 6
while True:
    sensor_id = bytes_data[index]

    sensor_plan = reader.get_sensor_data_plan(sensor_id)
    sensor_size = sum(info[0] for _, info in sensor_plan)  # bits
    sensor_bytes = bytes_data[index:index + (sensor_size + 7) // 8]


    print("-----")
    print(f"SENSOR: {sensor_id}  ({reader.SENSORS[sensor_id][0]})")
    print("BYTES: ", sensor_bytes.hex().upper())
    print("SIZE:  ", sensor_size // 8, "bytes")

    dt = reader.unpack_data(sensor_plan, sensor_bytes)

    sensor_delta = dt['second']*1000 + dt['mili']
    t += sensor_delta

    hour = (t // 3600000) % 24
    minute = (t // 60000) % 60
    second = (t // 1000) % 60
    milisecond = t % 1000

    print("TIME:  ", f"{hour}:{minute}:{second}.{milisecond}   (+{sensor_delta/1000}s)")

    print("DATA:")
    for i, dt_info in enumerate(reader.SENSORS[sensor_id][1]):
        value = dt["#" + str(i)]
        print(f"  > {value} ({dt_info[1]})")

    print()
    index += (sensor_size + 7) // 8

    if index >= len(bytes_data):
        break
